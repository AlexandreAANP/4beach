{% extends 'base.html.twig' %}
{% set totalProducts = 0 %}
{% set totalProductsPrice = 0.00 %}

{% block body %}
    <form id="form_checkout_gateway" method="POST" class="needs-validation" novalidate>
        <input type="hidden" name="is_frontoffice_cart" value='true'>
        <input type="hidden" id="checkout_customer_invoice_id" name="customer_invoice_id">
        <section>
            <div class="container mb-0">
                <h2 class="h1-responsive font-weight-bold text-center mt-4 mb-0">{% trans %}CHECKOUT{% endtrans %}</h2>
                <p class="text-center w-responsive mx-auto mb-3">Check your products and choose the payment method</p>
            </div>
            <div class="container mt-0">
                <div id="product_cart_items_loading" class="p-5 text-center">
                    <div class="spinner-border" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                </div>

                <div id="product_cart_items" style="display: none">
                    {% if (product.listProductItemStock is defined) and (product.listProductItemStock|length > 0) %}
                        <div class="row bg-light border p-2 mb-2">
                            <div class="col h5 product-cart-title-line-1 px-0 text-center">{% trans %}Image{% endtrans %}</div>
                            <div class="col h5 product-cart-title-line-2 px-0">{% trans %}Name{% endtrans %}</div>
                            <div class="col h5 product-cart-title-line-3 px-0 text-center">{% trans %}Price{% endtrans %}</div>
                            <div class="col h5 product-cart-title-line-3 px-0 text-center">{% trans %}Quantity{% endtrans %}</div>
                            <div class="col h5 product-cart-title-line-3 px-0 text-center">{% trans %}Sub total{% endtrans %}</div>
                        </div>

                        {% set productQuantity = product.productQuantity %}
                        {% set productPriceQuantity = product.productPriceQuantity %}
                        {% set productPrice = product.productPrice %}

                        {% for key,item in product.listProductItemStock %}
                            {% set bgcolor = key % 2 ? '#fafafa' : '#fff' %}

                            <div class="row mb-2 py-1 border" style="background: {{ bgcolor }}">
                                <div class="col product-cart-line-1 px-1 text-center align-middle my-auto"><img src="{{ item.filename }}" class="img-fluid" style="max-height: 60px"></div>
                                <div class="col product-cart-line-2 px-1 align-middle my-auto">
                                    {% if item.productAdditionalFields.checkout is defined %}
                                        <button
                                                type="button"
                                                class="btn animate__animated animate__pulse animate__faster animate__infinite infinite btn-outline-warning more-data-checkout"
                                                data-productid="{{ item.productItemStockId }}"
                                                data-toggle="collapse"
                                                data-target="#collapseItem{{ item.productItemStockId }}"
                                                aria-expanded="false"
                                                aria-controls="collapseItem{{ item.productItemStockId }}">
                                            <small class="d-block">{% trans %}click{% endtrans %}</small>
                                            <i class="fas fa-exclamation-triangle"></i>
                                            <small class="d-block">{% trans %}here{% endtrans %}</small>
                                        </button>
                                    {% endif %}

                                    <div class="d-block w-100 h5">{{ item.name }}</div>
                                    {% if item.productTypeReferenceKey == 'physical-products' %}
                                        <div class="d-block w-100">
                                            {% trans %}Color{% endtrans %}: {{ product.productItems[item.productItemStockId].color }} | {% trans %}Size{% endtrans %}: {{ product.productItems[item.productItemStockId].size }}
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="col col-3 h6 product-cart-line-0 text-center" style="display: none">{% trans %}Price{% endtrans %}</div>
                                <div class="col col-3 h6 product-cart-line-0 text-center" style="display: none">{% trans %}Quantity{% endtrans %}</div>
                                <div class="col col-3 h6 product-cart-line-0 text-center" style="display: none">{% trans %}Sub Total{% endtrans %}</div>

                                <div class="col product-cart-line-3 text-center align-middle my-auto" style="width: 10%">
                                    {{ productPrice[item.productItemStockId] }}
                                </div>
                                <div class="col product-cart-line-3 text-center align-middle my-auto">
                                    {% if item.allowQuantity %}
                                        {% if item.productTypeReferenceKey == 'physical-products' %}
                                            {{ productQuantity[item.productItemStockId] }}
                                        {% else %}
                                            <button class="btn btn-outline-primary">{% trans %}Availability{% endtrans %}</button>
                                        {% endif %}
                                    {% endif %}
                                </div>
                                <div class="col product-cart-line-3 text-center align-middle my-auto">
                                    {{ productPriceQuantity[item.productItemStockId] }}
                                </div>
                            </div>

                            {% if item.productAdditionalFields is defined %}
                                <div>
                                    <div class="collapse p-0 m-0" id="collapseItem{{ item.productItemStockId }}">
                                        <div class="form-row p-0 mx-0 mb-3">
                                            <input type="hidden" name="product_id[]" value="{{ item.productItemStockId }}">

                                            {% set colAdditionalFields = item.productAdditionalFields %}
                                            {% set fieldPrefix = item.productItemStockId ~ '_' %}
                                            {% set divOptions = {'class': 'p-2 w-50', 'style': ''} %}
                                            {% set fieldExcluded = ['product_id', 'order_id'] %}
                                            {% include '/_includes/additional_fields.html.twig' %}
                                        </div>
                                    </div>
                                </div>
                            {% endif %}

                        {% endfor %}

                    {% else %}
                        <tbody>
                        <tr>
                            <td class="text-center" scope="col">
                                <h3>{% trans %}There is no Product in Cart{% endtrans %}</h3>
                                <a href="./" style="border:#ff5a2c solid 3px; color:#ff5a2c; background:transparent" data-loading-text="Backing" class="btn mt-2">{% trans %}Go to Product List{% endtrans %}</a>
                            </td>
                        </tr>
                        </tbody>
                    {% endif %}
                </div>

                <div class="pb-4 mb-4">
                    <div class="d-flex justify-content-end align-items-center">
                        <a href="{{ baseUri }}/product-cart" style="border:#ff5a2c solid 3px; color:#ff5a2c; background: transparent" data-loading-text="Backing" class="btn mx-3">{% trans %}Back to Cart{% endtrans %}</a>

                        <div class="p-0 ml-5">
                            <div class="h6 p-2 text-right font-weight-bold small" style="margin-bottom:-10px; color:#ff5a2c">Total</div>
                            <div class="h2 p-2 text-right font-weight-bold text-danger">{{ product.totalPrice }} â‚¬</div>
                            <input type="hidden" id="total_products" name="total_products" value="{{ totalProducts }}">
                            <input type="hidden" id="total_products_price" name="total_products_price" value="{{ totalProductsPrice }}">
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="container">
            <div class="d-block w-100">
                <ul class="nav nav-tabs float-right" id="checkoutTab" role="tablist">
                    {% set activeInvoice = '' %}
                    {% set ariaSelectedInvoice = 'false' %}
                    {% set showInvoice = '' %}

                    {% if enableAddressOnCheckout %}
                        <li class="nav-item">
                            <a class="nav-link active" id="address_tab" data-toggle="tab" href="#address" role="tab" aria-controls="address" aria-selected="true">Address</a>
                        </li>
                    {% else %}
                        {% set activeInvoice = 'active' %}
                        {% set ariaSelectedInvoice = 'true' %}
                        {% set showInvoice = 'show active' %}
                    {% endif %}

                    {% if enableInvoiceOnCheckout %}
                        <li class="nav-item">
                            <a class="nav-link {{ activeInvoice }}" id="invoice_one_tab" data-toggle="tab" href="#invoice_one" role="tab" aria-controls="invoice-one" aria-selected="{{ ariaSelectedInvoice }}">Invoice One</a>
                        </li>
                        {% if LayoutFunctions.getEnvVars('SHOW_CHECKOUT_INVOICE_MULTIPLE') == 'true' %}
                            <li class="nav-item">
                                <a class="nav-link" id="invoice_multiple_tab" data-toggle="tab" href="#invoice_multiple" role="tab" aria-controls="invoice-multiple" aria-selected="false">Invoice Multiple</a>
                            </li>
                        {% endif %}
                    {% endif %}
                </ul>
                {% if enableAddressOnCheckout %}
                    <div class="tab-content" id="checkoutTabContent">
                        <div class="tab-pane fade show active" id="address" role="tabpanel" aria-labelledby="home-tab">
                            <div class="container mb-4">
                                {% set customerAddressLength = customerAddress|length %}
                                {% if customerAddressLength %}
                                    {% set addressChecked = '' %}
                                    {% if customerAddressLength == 1 %}
                                        {% set addressChecked = 'CHECKED' %}
                                    {% endif %}
                                    <div class="row">
                                        <div class="bg-light w-100 my-2 mr-1 p-1 pt-2 border rounded text-center">
                                            <h5>{% trans %}Select an address below for we ship your order {% endtrans %}</h5>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="row d-block text-center">
                                            {% for address in customerAddress %}
                                                <div class="d-inline-block col-md-5 my-3">
                                                    <div class="card border rounded">
                                                        <div class="card-header">
                                                            <div class="">
                                                                <div class="custom-control custom-radio">
                                                                    <input type="radio" class="custom-control-input customer-address-saved" name="customer_address_id" value="{{ address.id }}" id="customer_address_{{ address.id }}" {{ addressChecked }}>
                                                                    <label class="custom-control-label" for="customer_address_{{ address.id }}">Address {{ loop.index }}</label>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="card-body">
                                                            <div class="d-inline-block text-left">
                                                                <b>{% trans %}Line 1:{% endtrans %}</b> {{ address.line1 }}<BR>
                                                                <b>{% trans %}Line 2:{% endtrans %}</b> {{ address.line2 }}<BR>
                                                                <b>{% trans %}City:{% endtrans %}</b> {{ address.city }}<BR>
                                                                <b>{% trans %}State:{% endtrans %}</b> {{ address.state }}<BR>
                                                                {% if address.countryId is defined %}
                                                                    <b>{% trans %}Country:{% endtrans %}</b> {{ address.countryId }}<BR>
                                                                {% endif %}
                                                                <b>{% trans %}Postal Code:{% endtrans %}</b> {{ address.postalCode }}<BR>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}

                                            <div class="d-inline-block col-md-5 my-3">
                                                <div class="card border rounded">
                                                    <div class="card-header bg-info">
                                                        <div class="">
                                                            <div class="custom-control custom-radio">
                                                                <input type="radio" class="custom-control-input" name="customer_address_id" value="new" id="customer_address_new">
                                                                <label class="custom-control-label" for="customer_address_new"><span id="label_customer_address_new" class="text-white">New Address</span></label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="card-body">
                                                        <div id="new_customer_address_description">
                                                            {% trans %}Select this option for creating a new Address{% endtrans %}
                                                        </div>
                                                        <div id="new_customer_address_fields" class="text-left" style="height: 0; display: none!important">
                                                            <div class="form-group">
                                                                <label for="new_address_line_1">{% trans %}Line 1{% endtrans %}</label>
                                                                <input type="text" class="form-control" name="new_address_line1" id="new_address_line_1" placeholder="Line 1">
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="new_address_line_1">{% trans %}Line 2{% endtrans %}</label>
                                                                <input type="text" class="form-control" name="new_address_line2" id="new_address_line_2" placeholder="Line 2">
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="new_address_country">{% trans %}Country{% endtrans %}</label>
                                                                <input type="text" class="form-control" name="new_address_country" id="new_address_country" placeholder="Country">
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="new_address_state">{% trans %}State{% endtrans %}</label>
                                                                <input type="text" class="form-control" name="new_address_state" id="new_address_state" placeholder="State">
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="new_address_city">{% trans %}City{% endtrans %}</label>
                                                                <input type="text" class="form-control" name="new_address_city" id="new_address_city" placeholder="City">
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="new_address_postal_code">{% trans %}Postal Code{% endtrans %}</label>
                                                                <input type="text" class="form-control" name="new_address_postal_code" id="new_address_postal_code" placeholder="Postal Code">
                                                            </div>
                                                            <div class="form-group text-right">
                                                                <div class="custom-control custom-checkbox">
                                                                    <input type="checkbox" class="custom-control-input" name="new_address_save" id="new_address_save">
                                                                    <label class="custom-control-label" for="new_address_save">{% trans %}Add this Address to My Account{% endtrans %}</label>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endif %}

                {% if enableInvoiceOnCheckout %}
                    <div class="tab-pane fade {{ showInvoice }}" id="invoice_one" role="tabpanel" aria-labelledby="invoice-one-tab">
                        <div class="container mb-4">

                            {% set customerInvoiceLength = customerInvoice|length %}

                            <div class="row">
                                <div class="bg-light w-100 my-2 p-1 pt-2 border rounded text-center">
                                    <h5>{% trans %}Select an invoice below for we send your bill{% endtrans %}</h5>
                                </div>
                            </div>

                            {% if customerInvoiceLength %}
                                {% set invoiceChecked = '' %}
                                {% if customerInvoiceLength == 1 %}
                                    {% set invoiceChecked = 'CHECKED' %}
                                {% endif %}

                                <div class="box-customer-one-invoice">
                                    <div class="row d-block text-center">
                                        {% for invoice in customerInvoice %}
                                            <div class="d-inline-block col-md-4 my-3">
                                                <div class="card border rounded">
                                                    <div class="card-header">
                                                        <div class="">
                                                            <div class="custom-control custom-radio">
                                                                <input type="radio" class="custom-control-input customer-one-invoice" name="customer_invoice" value="{{ invoice.id }}" id="customer_invoice_{{ invoice.id }}" {{ invoiceChecked }}>
                                                                <label class="custom-control-label" for="customer_invoice_{{ invoice.id }}">Invoice {{ loop.index }}</label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="d-inline-block text-left">
                                                            <b>{% trans %}Line 1:{% endtrans %}</b> {{ invoice.line1 }}<BR>
                                                            <b>{% trans %}Line 2:{% endtrans %}</b> {{ invoice.line2 }}<BR>
                                                            <b>{% trans %}City:{% endtrans %}</b> {{ invoice.city }}<BR>
                                                            <b>{% trans %}State:{% endtrans %}</b> {{ invoice.state }}<BR>
                                                            <b>{% trans %}Country:{% endtrans %}</b> {{ invoice.countryId }}<BR>
                                                            <b>{% trans %}Postal Code:{% endtrans %}</b> {{ invoice.postalCode }}<BR>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}

                                        <div class="d-inline-block col-md-4 mb-3">
                                            <div class="card border rounded">
                                                <div class="card-header bg-info">
                                                    <div class="">
                                                        <div class="custom-control custom-radio">
                                                            <input type="radio" class="custom-control-input customer-one-invoice" name="customer_invoice" value="new" id="new_one_customer_invoice">
                                                            <label class="custom-control-label" for="new_one_customer_invoice"><span id="label_customer_invoice_new" class="text-white">New Invoice</span></label>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="card-body">
                                                    <div id="new_customer_invoice_description">
                                                        Select this option for creating a new Invoice
                                                    </div>
                                                    <div id="new_one_customer_invoice_fields" class="text-left d-none">

                                                        <div class="form-group">
                                                            <label for="new_invoice_line_1">Line 1</label>
                                                            <input type="text" class="form-control new-customer-invoice" name="new_invoice_line1" id="new_invoice_line_1" placeholder="Line 1">
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="new_invoice_line_1">Line 2</label>
                                                            <input type="text" class="form-control new-customer-invoice" name="new_invoice_line2" id="new_invoice_line_2" placeholder="Line 2">
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="new_invoice_country">Country</label>
                                                            {% if colGeoCountry is defined and colGeoCountry|length > 0 %}
                                                                <select class="custom-select form-control new-customer-invoice" id="new_invoice_country" name="new_invoice_country">
                                                                    <option selected value="">{% trans %}Choose{% endtrans %}...</option>
                                                                    {% for country in colGeoCountry %}
                                                                        <option value="{{country.id}}">{{country.name}}</option>
                                                                    {% endfor %}
                                                                </select>
                                                            {% endif %}
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="new_invoice_state">State</label>
                                                            <input type="text" class="form-control new-customer-invoice" name="new_invoice_state" id="new_invoice_state" placeholder="State">
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="new_invoice_city">City</label>
                                                            <input type="text" class="form-control new-customer-invoice" name="new_invoice_city" id="new_invoice_city" placeholder="City">
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="new_invoice_postal_code">Postal Code</label>
                                                            <input type="text" class="form-control new-customer-invoice" name="new_invoice_postal_code" id="new_invoice_postal_code" placeholder="Postal Code">
                                                        </div>
                                                        <div class="form-group text-right">
                                                            <div class="custom-control custom-checkbox">
                                                                <input type="checkbox" class="custom-control-input new-customer-invoice" name="new_invoice_save" id="customer_invoice_new_save" value="save">
                                                                <label class="custom-control-label" for="customer_invoice_new_save">Add this Invoice to My Account</label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    {# END OF INVOICE ONE - START INVOICE MULTIPLE #}

                    {% if LayoutFunctions.getEnvVars('SHOW_CHECKOUT_INVOICE_MULTIPLE') == 'true' %}
                        <div class="tab-pane fade" id="invoice_multiple" role="tabpanel" aria-labelledby="invoice-multiple-tab">
                            <div class="container mb-4">
                                <div class="row">
                                    <div class="bg-light w-100 my-2 p-1 pt-2 border rounded text-center">
                                        <h5>{% trans %}Select the invoices below for we send your bills{% endtrans %}</h5>
                                    </div>
                                </div>

                                <div id="box_more_invoices">
                                    <div id="dinamic_invoice" class="row d-block text-center">
                                        {% set customerInvoiceLength = customerInvoice|length %}
                                        {% if customerInvoiceLength %}
                                            {% set invoiceChecked = '' %}
                                            {% if customerInvoiceLength == 1 %}
                                                {% set invoiceChecked = 'CHECKED' %}
                                            {% endif %}

                                            {% for invoice in customerInvoice %}
                                                <div class="d-inline-block col-auto my-3">
                                                    <div class="card border rounded">

                                                        <div class="card-header">
                                                            <div class="">
                                                                <div class="custom-control custom-checkbox">
                                                                    <input type="checkbox" class="custom-control-input customer-more-invoice" name="customer_invoices[]" value="{{ invoice.id }}" id="customer_invoices_{{ invoice.id }}">
                                                                    <label class="custom-control-label" for="customer_invoices_{{ invoice.id }}">Invoice {{ invoice.id }}</label>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="card-body">
                                                            <div class="d-inline-block text-left">
                                                                <b>{% trans %}Nome:{% endtrans %}</b> {{ invoice.name }}<BR>
                                                                <b>{% trans %}Line 1:{% endtrans %}</b> {{ invoice.line1 }}<BR>
                                                                <b>{% trans %}Line 2:{% endtrans %}</b> {{ invoice.line2 }}<BR>
                                                                <b>{% trans %}City:{% endtrans %}</b> {{ invoice.city }}<BR>
                                                                <b>{% trans %}State:{% endtrans %}</b> {{ invoice.state }}<BR>
                                                                <b>{% trans %}Country:{% endtrans %}</b> {{ invoice.countryId }}<BR>
                                                                <b>{% trans %}Postal Code:{% endtrans %}</b> {{ invoice.postalCode }}<BR>
                                                                <div class="form-group mt-3 p-2 customer-invoice-value-box d-none" id="container_box_{{ invoice.id }}">

                                                                    <p class="">
                                                                        <input class="form-check-input customer-invoice-format" type="radio" name="invoice_format_{{invoice.id }}" id="invoice_format_{{invoice.id }}_1" value="product">
                                                                        <label for="invoice_format_{{ invoice.id }}_1">{% trans %}Bill by Product{% endtrans %}</label>
                                                                    </p>

                                                                    <div class="customer-invoice-format-products d-none">
                                                                        {% for item in product.listProductItemStock %}
                                                                            <div class="form-check ml-2">
                                                                                <input class="form-check-input customer-invoice-format-products-input" type="radio" name="customer_invoice_product[{{ invoice.id }}][{{ item.productItemStockId }}]" id="invoice_product_{{ invoice.id }}_{{ item.productItemStockId }}" value="{{ productPrice[item.productItemStockId] }}">
                                                                                <label class="form-check-label" for="invoice_product_{{ invoice.id }}_{{ item.productItemStockId }}">{{ item.name }}</label>
                                                                            </div>
                                                                        {% endfor %}
                                                                    </div>

                                                                    <hr>

                                                                    <p class="">
                                                                        <input class="form-check-input customer-invoice-format" type="radio" name="invoice_format_{{invoice.id }}" id="invoice_format_{{invoice.id }}_2" value="values">
                                                                        <label for="invoice_format_{{invoice.id }}_2">{% trans %}Or sharing the price between invoices{% endtrans %}</label>
                                                                    </p>

                                                                    <div class="form-group ml-2 customer-invoice-format-values d-none">
                                                                        <label for="customer_invoice_value_{{ invoice.id }}">Enter the invoice amount here:</label>
                                                                        <input type="number" class="form-control customer-invoice-format-values-input" placeholder="Enter value" id="customer_invoice_value_{{ invoice.id }}" name="customer_invoice_value[{{ invoice.id }}]" pattern="[0-9]+([\.,][0-9]+)?" step="0.01">
                                                                        <div class="remaining" data-total-price="{{ totalProductsPrice }}">
                                                                            <label>{% trans %}Remaining{% endtrans %}: </label>
                                                                            <label class="remaining-value">{{ totalProductsPrice }}</label>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                            <div class="d-inline-block col-md-4 mb-3">
                                                <div class="card border rounded">
                                                    <div class="card-header bg-info">
                                                        <div class="">
                                                            <div class="custom-control custom-checkbox">
                                                                <input type="checkbox" class="custom-control-input customer-more-invoice" name="multiple_customer_invoice_new" value="new" id="multiple_customer_invoice_new">
                                                                <label class="custom-control-label" for="multiple_customer_invoice_new"><span id="label_customer_invoice_new" class="text-white">New Invoice</span></label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="card-body">
                                                        <div id="new_multiple_invoice_fields_description">
                                                            Select this option for creating a new Invoice
                                                        </div>
                                                        <div id="new_multiple_invoice_fields" class="text-left" style="height: 0; display: none!important">
                                                            <div class="form-group">
                                                                <label for="new_multiple_invoice_line_1">Line 1</label>
                                                                <input type="text" class="form-control new-multiple-customer-invoice" name="new_multiple_invoice_line1" id="new_multiple_invoice_line_1" placeholder="Line 1">
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="new_multiple_invoice_line_2">Line 2</label>
                                                                <input type="text" class="form-control new-multiple-customer-invoice" name="new_multiple_invoice_line2" id="new_multiple_invoice_line_2" placeholder="Line 2">
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="new_multiple_invoice_country">Country</label>
                                                                {% if colGeoCountry is defined and colGeoCountry|length > 0 %}
                                                                    <select class="custom-select form-control new-multiple-customer-invoice" id="new_multiple_invoice_country" name="new_multiple_invoice_country">
                                                                        <option selected value="">{% trans %}Choose{% endtrans %}...</option>
                                                                        {% for country in colGeoCountry %}
                                                                            <option value="{{country.id}}">{{country.name}}</option>
                                                                        {% endfor %}
                                                                    </select>
                                                                {% endif %}
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="new_multiple_invoice_state">State</label>
                                                                <input type="text" class="form-control new-multiple-customer-invoice" name="new_multiple_invoice_state" id="new_multiple_invoice_state" placeholder="State">
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="new_multiple_invoice_city">City</label>
                                                                <input type="text" class="form-control new-multiple-customer-invoice" name="new_multiple_invoice_city" id="new_multiple_invoice_city" placeholder="City">
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="new_multiple_invoice_postal_code">Postal Code</label>
                                                                <input type="text" class="form-control new-multiple-customer-invoice" name="new_multiple_invoice_postal_code" id="new_multiple_invoice_postal_code" placeholder="Postal Code">
                                                            </div>
                                                            <div class="form-group text-center">
                                                                <button type="button" class="btn btn-info p-3" id="btn_new_multiple_invoice">{% trans %}Add{% endtrans %}</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                {% endif %}
            </div>
        </section>
    </form>

    <section>
        <div class="container" style="margin-bottom: 100px">
            <div class="row">
                <div class="bg-light w-100 my-2 p-1 pt-2 border rounded text-center">
                    <h5>
                        {% trans %}Select a Payment Gateway{% endtrans %}
                    </h5>
                </div>
            </div>
            <div>
                <div class="row d-block text-center">
                    {% if listPaymentGateway|length %}
                        <div class="row justify-content-center">
                            {% for paymentGateway in listPaymentGateway %}
                                <div class="card border-0 m-2 text-center" style="min-width: 180px">
                                    {% if paymentGateway.referenceKey == 'payment_gateway_none' or paymentGateway.referenceKey == 'payment_gateway_check_availability' %}
                                        <button data-gateway="{{baseUri}}{{ paymentGateway.link }}" class="btn btn-dark text-white btn-checkout-gateway" style="width: 100%; font-size: 20px; padding: 15px 10px; font-weight: bold; white-space: nowrap">
                                            {{ paymentGateway.name }}
                                        </button>
                                    {% else %}
                                        <button data-gateway="{{baseUri}}{{baseUri}}{{ paymentGateway.link }}" class="btn btn-dark btn-checkout-gateway" style="width: 100%">
                                            <i class="fab {{ paymentGateway.icon}} fa-3x text-white"></i>
                                        </button>
                                        <span class="small">Pagar com <strong>{{ paymentGateway.name }}</strong></span>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </section>
{% endblock %}

{% block javascripts %}

    {{ parent() }}

    <script>
        $(document).ready(function() {
            var options = {};
            querybizProduct.init(options);
            querybizProduct.showCart('checkout/auth');
        });
    </script>

    <script>
        var enableInvoiceOnCheckout = {{ enableInvoiceOnCheckout ? 'true' : 'false' }};

        $(function() {
            $('.btn-checkout-gateway').click(function(e) {
                e.preventDefault();

                let invoiceIdChecked = 0;
                let arOneInvoice = $('.customer-one-invoice');
                for (let i = 0; i < arOneInvoice.length; i++) {
                    let el = $(arOneInvoice[i]);
                    if (el.prop('checked')) {
                        invoiceIdChecked = el.val();
                    }
                }

                if (!invoiceIdChecked && enableInvoiceOnCheckout) {
                    alert('You need to select an Invoice');
                } else {
                    if ($('#checkout_customer_invoice_id').length) {
                        $('#checkout_customer_invoice_id').val(invoiceIdChecked);
                    }

                    let gateway = $(this).attr('data-gateway');
                    $('#form_checkout_gateway').attr('action', gateway);
                    $('#form_checkout_gateway').submit();
                }
            });

            $('#customer_address_new').click(function() {
                $('#new_customer_address_description').hide();
                $('#new_customer_address_fields').show().animate({height: '490px'});
            });

            $('.customer-address-saved').click(function() {
                $('#new_customer_address_fields').animate({height: '0px'}, function() {
                    $(this).hide();
                    $('#new_customer_address_description').show();
                });
            });

        });

        (function() {
            'use strict';
            window.addEventListener('load', function() {

                const totalProducts = $("input#total_products").val();
                const totalProductsPrice = parseFloat($("input#total_products_price").val());
                var inputedValueInvoice = 0.00;

                var selectTotalValuesToInvoices = 0;

                console.log(`totalProducts: ${totalProducts}\ntotalProductsPrice: ${totalProductsPrice}`);

                $('#customer_address_new').click(function() {
                    $('#new_customer_address_description').hide();
                    $('#new_customer_address_fields').show().animate({height: '490px'});
                });

                $('input:radio#new_one_customer_invoice').click(function(evt){
                    if($(this).prop('checked')){
                        $('div#new_one_customer_invoice_fields').removeClass('d-none');
                    }else{
                        $('div#new_one_customer_invoice_fields').addClass('d-none');
                    }
                });

                //more_invoice format exibition
                $('input:checkbox.customer-more-invoice').on("click", function(){
                    let idEl = $(this).val();
                    if($(this).prop('checked')){
                        $('div#container_box_'+idEl).removeClass('d-none');
                    } else {
                        $('div#container_box_'+idEl).addClass('d-none');
                    }
                });

                var forms = document.getElementsByClassName('needs-validation');
                var validation = Array.prototype.filter.call(forms, function(form) {
                    form.addEventListener('submit', function(event) {
                        var btnAction = $('.btn-form-action');
                        btnAction.prop('disabled',true);
                        btnAction.append('<span id="spinner-loading" class="spinner-border spinner-border-sm d-block mx-auto" role="status" aria-hidden="true"></span>');

                        if (form.checkValidity() === false) {
                            event.preventDefault();
                            event.stopPropagation();
                            Swal.fire('Atention!','There are required fields not filled in!','warning');
                            $('.more-data-checkout').trigger('click');
                        }

                        //valida one invoice : ok
                        if($('input:radio#one_invoice').prop('checked'))
                        {

                            let totalRadiosSelecteds = $(':radio[name="customer_invoice"]:checked').length;
                            if(totalRadiosSelecteds<1) {
                                Swal.fire('Atention','You need to choose one of the options!','warning');
                                event.preventDefault();
                                event.stopPropagation();
                            }

                        }

                        //more invoices selecionado
                        if($('input:radio#more_invoice').prop('checked'))
                        {

                            //verifica se pessoa/invoice nÃ£o estÃ¡ selecionado
                            let totalRadiosSelecteds = ($(':checkbox[name="customer_invoices[]"]:checked').length>0)?$(':checkbox[name="customer_invoices[]"]:checked').length:0;
                            if(totalRadiosSelecteds<1)
                            {
                                Swal.fire('Atention','You need to choose one of the options to Invoice','warning');
                                $(':checkbox[name="customer_invoices[]"]').focus();
                                event.preventDefault();
                                event.stopPropagation();
                            }
                            else
                            {

                                //verifica se formato NÃƒO FOI selecionado
                                let totalRadiosInvoiceFormatProduct = ($(':radio[value="product"]:checked').length>0)?$(':radio[value="product"]:checked').length:0;
                                let totalRadiosInvoiceFormatValues = ($(':radio[value="values"]:checked').length>0)?$(':radio[value="values"]:checked').length:0;
                                if(totalRadiosSelecteds>0 && totalRadiosInvoiceFormatProduct<1 && totalRadiosInvoiceFormatValues<1 ) {
                                    Swal.fire('Atention','You need to choose Bill by Product or Share the price between invoices','warning');
                                    $(':radio.customer-invoice-format').focus().fadeIn("slow");
                                    event.preventDefault();
                                    event.stopPropagation();
                                }
                                else
                                {

                                    if($(':radio[value="product"]:checked').prop('checked'))
                                    {

                                        let totalSelectedProductsInvoice = $(':radio.customer-invoice-format-products-input:checked').length;
                                        //verifica se algum produto NÃƒO FOI selecionado para fatura
                                        if(totalSelectedProductsInvoice<1){
                                            Swal.fire('Atention','You need to select products','warning');
                                            event.preventDefault();
                                            event.stopPropagation();
                                        }
                                        else
                                        {

                                            //verifica SE TODOS os produtos foram selecionados
                                            if(totalSelectedProductsInvoice<totalProducts) {
                                                let productNotSelectedToInvoice = parseInt(totalProducts-totalSelectedProductsInvoice);
                                                Swal.fire('Atention',`You still need to select ${productNotSelectedToInvoice} products`,'warning');
                                                event.preventDefault();
                                                event.stopPropagation();
                                            }

                                        }

                                    }

                                    if($(':radio[value="values"]:checked').prop('checked'))
                                    {

                                        let remaining = parseFloat(parseFloat(totalProductsPrice)-parseFloat(inputedValueInvoice));
                                        if((inputedValueInvoice<totalProductsPrice)) {
                                            Swal.fire('Atention',`There are still ${remaining.toFixed(2)} to distribute on invoices`,'warning');
                                            event.preventDefault();
                                            event.stopPropagation();
                                        }

                                        if(inputedValueInvoice==0.00) {
                                            Swal.fire('Atention',`Enter the invoice amount`,'warning');
                                            event.preventDefault();
                                            event.stopPropagation();
                                        }

                                    }


                                }

                            } //END: more invoices selecionado


                        }

                        btnAction.prop('disabled',false);
                        $('span#spinner-loading').remove();
                        form.classList.add('was-validated');

                    }, false);
                });

                $('.customer-invoice-format').click(function(){

                    let elId = $(this).attr('id');
                    let elVal = $(this).val();

                    if(elVal=='product')
                    {

                        selectTotalValuesToInvoices = 0;
                        inputedValueInvoice = 0.00;
                        let remaining = $('.remaining').data('total-price').toFixed(2);
                        $('.remaining-value').html(remaining);
                        $('input:radio[value="product"].customer-invoice-format').prop('checked',true);
                        $('div.customer-invoice-format-products').removeClass('d-none').show('fast');
                        $('input:radio.customer-invoice-format-products-input').prop('disabled',false);
                        $('.customer-invoice-format-values').addClass('d-none');
                        $('input.customer-invoice-format-values-input').val('').prop('disabled',true);

                        resetRemaining();

                    }
                    else
                    {

                        $('input:radio[value="values"].customer-invoice-format').prop('checked',true);
                        $('.customer-invoice-format-values').removeClass('d-none');
                        $('input.customer-invoice-format-values-input').val('').prop('disabled',false);
                        $('input:radio[value="product"].customer-invoice-format').prop('checked',false);
                        $('.customer-invoice-format-products').addClass('d-none');
                        $('input:radio.customer-invoice-format-products-input').prop('disabled',true);
                        $('input:radio.customer-invoice-format-products-input').prop('checked',false);

                    }
                });

                $('.customer-invoice-format-values-input').blur(function(evt){

                    let inputValue = ($(this).val()).trim();

                    if(inputValue.length>1) {

                        console.log("\nlinha 752: inputedValueInvoice: " + inputedValueInvoice);

                        inputedValueInvoice = parseFloat(inputedValueInvoice) + parseFloat(inputValue);

                        console.log("\nlinha 756: inputedValueInvoice + entrada: " + inputedValueInvoice);

                        let remaining = parseFloat(parseFloat(totalProductsPrice) - inputedValueInvoice).toFixed(2);

                        if(inputedValueInvoice>totalProductsPrice) {

                            let correctValue = (parseFloat(inputValue)-Math.abs(remaining));
                            let exceedValue  = (parseFloat(inputValue)-correctValue);
                            inputedValueInvoice = parseFloat(totalProductsPrice);
                            Swal.fire('Atention!','Value exceeds in '+parseFloat(exceedValue).toFixed(2),'warning');

                            remaining = 0.00;
                            $(this).val(correctValue);
                            $(".remaining").data("total-price", remaining);
                            $(".remaining-value").html((remaining).toFixed(2));

                            console.log("\nlinha 772: inputedValueInvoice: " + inputedValueInvoice);

                            return false;
                        }
                        else if(inputedValueInvoice<totalProductsPrice)
                        {
                            Swal.fire('','You still have ' + parseFloat(remaining).toFixed(2) + ' to finalize you invoice' ,'success');
                        }
                        $(".remaining").data("total-price", remaining);
                        $(".remaining-value").html(remaining);

                    } else {
                        let inputedValues = 0.00;
                        let inputs = $('.customer-invoice-format-values-input');

                        for(let i=0;i<inputs.length;i++){
                            if( (inputs[i].value!="") && (parseFloat(inputs[i].value)>0.00) ){
                                inputedValues+=parseFloat(inputs[i].value);
                            }
                        }

                        if((inputedValues!="") || (inputedValues>0.00) ) {
                            inputedValueInvoice = parseFloat(inputedValues);
                            let remaining = parseFloat(totalProductsPrice - inputedValueInvoice);
                            $(".remaining").data("total-price", remaining );
                            $(".remaining-value").html((remaining).toFixed(2));
                            Swal.fire('','You still have ' + (remaining).toFixed(2) + ' to finalize you invoice' ,'success');
                        }

                        console.log("\nlinha 804: inputedValueInvoice: " + inputedValueInvoice);

                    }

                });

                function resetRemaining()
                {
                    inputedValueInvoice = 0.00;
                    $('.remaining').data('total-price', totalProductsPrice);
                    $('.remaining-value').html(parseFloat(totalProductsPrice).toFixed(2));
                    $('input.customer-invoice-format-values-input').val('');
                }

                $('#multiple_customer_invoice_new').click(function() {
                    $('#new_multiple_invoice_fields_description').hide();
                    $('#new_multiple_invoice_fields').show().animate({height: '520px'});
                });
            }, false);
        })();

        $(document).ready(function(){

            $("#btn_new_multiple_invoice").click(function(evt){

                $("div#box_more_invoices").removeClass('d-none');

                $("#btn_new_multiple_invoice").append('<span id="spinner-loading" class="spinner-border spinner-border-sm d-block mx-auto" role="status" aria-hidden="true"></span>');
                $("#btn_new_multiple_invoice").prop("disabled",true);

                let serviceAPI  = '/addCustomerInvoice';
                let customerId  = {{customerId}};
                let line1       = ($("#new_multiple_invoice_line_1").val()!="")      ?$("#new_multiple_invoice_line_1").val()     :null;
                let line2       = ($("#new_multiple_invoice_line_2").val()!="")      ?$("#new_multiple_invoice_line_2").val()     :null;
                let countryId   = ($("#new_multiple_invoice_country").val()!="")     ?$("#new_multiple_invoice_country").val()    :null;
                let city        = ($("#new_multiple_invoice_state").val()!="")       ?$("#new_multiple_invoice_state").val()      :null;
                let state       = ($("#new_multiple_invoice_city").val()!="")        ?$("#new_multiple_invoice_city").val()       :null;
                let postalCode  = ($("#new_multiple_invoice_postal_code").val()!="") ?$("#new_multiple_invoice_postal_code").val():null;

                let url	= `${arDefaultOptions['baseUri']}${serviceAPI}?customerId=${customerId}&line1=${line1}&line2=${line2}&countryId=${countryId}&city=${city}&state=${state}&postalCode=${postalCode}`
                querybiz.request(url,'POST',(msg)=>{

                    let customerInvoiceId = msg.customerInvoiceId;
                    console.log('customerInvoiceId: '+customerInvoiceId);
                    let loopIndex  = Math.floor(Math.random() * 1000000);
                    let container  = `<div class="d-inline-block col-auto my-3">
                                        <div class="card border rounded">

                                            <div class="card-header">
                                                <div class="">
                                                    <div class="custom-control custom-checkbox">
                                                        <input type="checkbox" class="custom-control-input customer-more-invoice" name="customer_invoices[]" value="${customerInvoiceId}" id="customer_invoices_${customerInvoiceId}">
                                                        <label class="custom-control-label" for="customer_invoices_${customerInvoiceId}">Invoice ${customerInvoiceId}</label>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="card-body">
                                                <div class="d-inline-block text-left">
                                                    <b>{% trans %}Nome{% endtrans %}:</b> <BR>
                                                    <b>{% trans %}Line 1{% endtrans %}:</b> ${line1}<BR>
                                                    <b>{% trans %}Line 2{% endtrans %}:</b> ${line2}<BR>
                                                    <b>{% trans %}City{% endtrans %}:</b> ${city}<BR>
                                                    <b>{% trans %}State{% endtrans %}:</b> ${state}<BR>
                                                    <b>{% trans %}Country{% endtrans %}:</b> ${countryId}<BR>
                                                    <b>{% trans %}Postal Code{% endtrans %}:</b> ${postalCode}<BR>
                                                    <div class="form-group mt-3 p-2 customer-invoice-value-box d-none" id="container_box_${customerInvoiceId}">

                                                        <p class="">
                                                            <input class="form-check-input customer-invoice-format" type="radio" name="invoice_format_${customerInvoiceId}" id="invoice_format_${customerInvoiceId}_1" value="product">
                                                            <label for="invoice_format_${customerInvoiceId}_1">{% trans %}Bill by Product{% endtrans %}</label>
                                                        </p>

                                                        <div class="customer-invoice-format-products d-none">
                                                            {% for item in product.listProductItemStock %}
                                                            <div class="form-check ml-2">
                                                                <input class="form-check-input customer-invoice-format-products-input" type="radio" name="customer_invoice_product[${customerInvoiceId}][{{ item.productItemStockId }}]" id="invoice_product_${customerInvoiceId}_{{ item.productItemStockId }}" value="{{ product.productPrice[item.productItemStockId] }}">
                                                                <label class="form-check-label" for="invoice_product_${customerInvoiceId}_{{ item.productItemStockId }}">{{ item.name }}</label>
                                                            </div>
                                                            {% endfor %}
                                                        </div>

                                                        <hr>

                                                        <p class="">
                                                            <input class="form-check-input customer-invoice-format" type="radio" name="invoice_format_${customerInvoiceId}" id="invoice_format_${customerInvoiceId}_2" value="values">
                                                            <label for="invoice_format_${customerInvoiceId}_2">{% trans %}Or sharing the price between invoices{% endtrans %}</label>
                                                        </p>

                                                        <div class="form-group ml-2 customer-invoice-format-values d-none">
                                                            <label for="customer_invoice_value_${customerInvoiceId}">Enter the invoice amount here:</label>
                                                            <input type="number" class="form-control customer-invoice-format-values-input" placeholder="Enter value" id="customer_invoice_value_${customerInvoiceId}" name="customer_invoice_value[${customerInvoiceId}]" pattern="[0-9]+([\.,][0-9]+)?" step="0.01">
                                                            <div class="remaining" data-total-price="{{ totalProductsPrice }}">
                                                                <label>{% trans %}Remaining{% endtrans %}: </label>
                                                                <label class="remaining-value">{{ totalProductsPrice }}</label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>`;

                    $( container ).appendTo( "#dinamic_invoice"  );

                    console.log(msg);

                    Swal.fire('Success!','Inserted Invoice','success');


                    $("#btn_new_multiple_invoice").prop("disabled",false);
                    $('span#spinner-loading').remove();

                    $("#new_multiple_invoice_line_1").val('').focus();
                    $("#new_multiple_invoice_line_2").val('');
                    $("#new_multiple_invoice_country").val('');
                    $("#new_multiple_invoice_state").val('');
                    $("#new_multiple_invoice_city").val('');
                    $("#new_multiple_invoice_postal_code").val('');


                },(msg)=>console.log("Error: " + msg));


            });

        });

    </script>
{% endblock %}